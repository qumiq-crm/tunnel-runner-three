<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Tunnel Runner</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <style>
      body { margin: 0; }
      #score-board {
        position: fixed;
        top: 2vw;
        left: 50%;
        transform: translateX(-50%);
        z-index: 100;
        background: rgba(16, 16, 42, 0.85);
        color: #fff;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 2.2vw;
        font-weight: bold;
        letter-spacing: 0.05em;
        padding: 0.6em 2em;
        border-radius: 1.2em;
        box-shadow: 0 2px 16px rgba(0,0,0,0.18);
        user-select: none;
        pointer-events: none;
        min-width: 120px;
        text-align: center;
      }
      @media (max-width: 600px) {
        #score-board {
          font-size: 4vw;
          padding: 0.5em 1.2em;
        }
      }
      #joystick-container {
        position: fixed;
        left: 50vw;
        bottom: 4vh; /* Moved more to the bottom */
        transform: translateX(-50%);
        z-index: 10;
        width: 18vw;
        height: 18vw;
        max-width: 340px;
        max-height: 340px;
        min-width: 160px;
        min-height: 160px;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        touch-action: none;
      }
      #joystick-base {
        width: 50%;
        height: 50%;
        background: rgba(60, 60, 80, 0.32);
        border-radius: 50%;
        border: 2.5px solid #3A86FF;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 12px rgba(0,0,0,0.18);
        pointer-events: auto;
        touch-action: none;
        transition: background 0.2s;
      }
      #joystick-knob {
        width: 20%;
        height: 20%;
        background: linear-gradient(145deg, #3A86FF 60%, #fff 100%);
        border-radius: 50%;
        border: 2.5px solid #fff;
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        box-shadow: 0 2px 12px rgba(0,0,0,0.22);
        pointer-events: auto;
        touch-action: none;
        transition: box-shadow 0.1s, background 0.2s;
        will-change: transform;
      }
      #joystick-knob.active {
        box-shadow: 0 4px 24px rgba(58,134,255,0.25);
        background: linear-gradient(145deg, #3A86FF 80%, #fff 100%);
      }
      @media (max-width: 600px) {
        #joystick-container {
          width: 60vw;
          height: 60vw;
          min-width: 120px;
          min-height: 120px;
          max-width: 90vw;
          max-height: 90vw;
          bottom: 2vh; /* Even closer to bottom on small screens */
        }
      }
      @media (max-width: 400px) {
        #joystick-container {
          width: 80vw;
          height: 80vw;
          min-width: 80px;
          min-height: 80px;
          bottom: 1vh;
        }
      }
      /* Loading overlay styles */
      #loading-overlay {
        position: fixed;
        z-index: 99999;
        top: 0; left: 0; right: 0; bottom: 0;
        width: 100vw; height: 100vh;
        background: linear-gradient(120deg, #10102a 80%, #3A86FF 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        transition: opacity 0.4s;
      }
      #loading-spinner {
        width: 64px;
        height: 64px;
        border: 7px solid #3A86FF;
        border-top: 7px solid #fff;
        border-radius: 50%;
        animation: spin 1.1s linear infinite;
        margin-bottom: 2vw;
      }
      @keyframes spin {
        0% { transform: rotate(0deg);}
        100% { transform: rotate(360deg);}
      }
      #loading-text {
        color: #fff;
        font-family: 'Segoe UI', Arial, sans-serif;
        font-size: 2.2vw;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-shadow: 0 2px 12px #0008;
        margin-top: 0.5em;
        text-align: center;
      }
      @media (max-width: 600px) {
        #loading-text { font-size: 4vw; }
        #loading-spinner { width: 40px; height: 40px; border-width: 5px; }
      }
    </style>
  </head>
  <body>
    <div id="loading-overlay">
      <div id="loading-spinner"></div>
      <div id="loading-text">Loading...</div>
    </div>
    <div id="joystick-container" >
      <div id="joystick-base"></div>
      <div id="joystick-knob"></div>
    </div>
    
    <script type="module" src="./main.js"></script>
    <script>
      // Responsive joystick logic
      const base = document.getElementById('joystick-base');
      const knob = document.getElementById('joystick-knob');
      const container = document.getElementById('joystick-container');
      let dragging = false;

      function getBaseCenterAndRadius() {
        const rect = base.getBoundingClientRect();
        return {
          x: rect.left + rect.width / 2,
          y: rect.top + rect.height / 2,
          r: rect.width / 2
        };
      }

      function setKnob(x, y) {
        knob.style.transform = `translate(-50%, -50%) translate(${x}px, ${y}px)`;
      }

      function resetKnob() {
        setKnob(0, 0);
        knob.classList.remove('active');
        // Dispatch event for "joystick released"
        const event = new CustomEvent('joystickMove', { detail: { x: 0, y: 0 } });
        window.dispatchEvent(event);
      }

      function handleMove(clientX, clientY) {
        const { x: cx, y: cy, r } = getBaseCenterAndRadius();
        let dx = clientX - cx;
        let dy = clientY - cy;
        // Clamp to base circle
        const dist = Math.sqrt(dx*dx + dy*dy);
        const knobRadius = base.offsetWidth * 0.19; // 38% / 2
        const maxDist = r - knobRadius;
        if (dist > maxDist) {
          dx = dx * maxDist / dist;
          dy = dy * maxDist / dist;
        }
        setKnob(dx, dy);
        // Dispatch event for "joystick moved"
        const normX = dx / maxDist;
        const normY = dy / maxDist;
        const event = new CustomEvent('joystickMove', { detail: { x: normX, y: normY } });
        window.dispatchEvent(event);
      }

      // Mouse events
      knob.addEventListener('mousedown', (e) => {
        dragging = true;
        knob.classList.add('active');
        e.preventDefault();
      });
      document.addEventListener('mousemove', (e) => {
        if (dragging) {
          handleMove(e.clientX, e.clientY);
        }
      });
      document.addEventListener('mouseup', (e) => {
        if (dragging) {
          dragging = false;
          resetKnob();
        }
      });

      // Touch events
      knob.addEventListener('touchstart', (e) => {
        dragging = true;
        knob.classList.add('active');
        e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchmove', (e) => {
        if (dragging && e.touches.length > 0) {
          handleMove(e.touches[0].clientX, e.touches[0].clientY);
        }
      }, { passive: false });
      document.addEventListener('touchend', (e) => {
        if (dragging) {
          dragging = false;
          resetKnob();
        }
      });

      // Prevent scrolling on joystick
      base.addEventListener('touchmove', e => e.preventDefault(), { passive: false });

      // Make sure joystick is always centered and responsive
      window.addEventListener('resize', resetKnob);

      // Initialize
      resetKnob();

      // --- Loading Overlay Logic ---
      // main.js should dispatch a custom event 'gameLoaded' when everything is ready.
      // Optionally, main.js can dispatch 'gameLoadingProgress' with {progress, text} for progress updates.

      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingText = document.getElementById('loading-text');
      const joystickContainer = document.getElementById('joystick-container');

      // Listen for progress updates (optional)
      window.addEventListener('gameLoadingProgress', (e) => {
        if (e.detail && e.detail.text) {
          loadingText.textContent = e.detail.text;
        }
        // Optionally, you could show a progress bar here using e.detail.progress (0-1)
      });

      // Listen for game loaded event
      window.addEventListener('gameLoaded', () => {
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
          loadingOverlay.style.display = 'none';
          joystickContainer.style.visibility = '';
        }, 400);
      });

      // If main.js never dispatches 'gameLoaded', overlay stays.
      // For accessibility, show joystick only after loading.
    </script>
  </body>
</html>